<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-PortSwigger/web-security/文件上传" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">文件上传 | C0rr3ct</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://C0rr3c7.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://C0rr3c7.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://C0rr3c7.github.io/docs/PortSwigger/web-security/文件上传"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="文件上传 | C0rr3ct"><meta data-rh="true" name="description" content="File upload vulnerabilities"><meta data-rh="true" property="og:description" content="File upload vulnerabilities"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://C0rr3c7.github.io/docs/PortSwigger/web-security/文件上传"><link data-rh="true" rel="alternate" href="https://C0rr3c7.github.io/docs/PortSwigger/web-security/文件上传" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://C0rr3c7.github.io/docs/PortSwigger/web-security/文件上传" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="C0rr3ct RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="C0rr3ct Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.aff420c1.css">
<script src="/assets/js/runtime~main.dcbf6bb1.js" defer="defer"></script>
<script src="/assets/js/main.2fdee944.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">C0rr3rt</b></a><a class="navbar__item navbar__link" href="/docs/HackMyVm/">HackMyVm</a><a class="navbar__item navbar__link" href="/docs/VulnHub/">VulnHub</a><a class="navbar__item navbar__link" href="/docs/HackTheBox/">HackTheBox</a><a class="navbar__item navbar__link" href="/docs/category/vulnstack">VulnStack</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/PortSwigger/">PortSwigger</a><a class="navbar__item navbar__link" href="/docs/category/玄机">应急响应</a><a class="navbar__item navbar__link" href="/docs/CTF/">CTF</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about">关于</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/PortSwigger/">PortSwigger</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/web-security">web-security</a><button aria-label="折叠侧边栏分类 &#x27;web-security&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/API测试">API测试</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/JWT">JWT</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/SQL注入">SQL注入</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/SSRF">SSRF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/XSS">XSS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/XXE">XXE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/信息泄露">信息泄露</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/命令执行">命令执行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/PortSwigger/web-security/文件上传">文件上传</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/路径遍历">路径遍历</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/PortSwigger/web-security/身份验证漏洞">身份验证漏洞</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/web-security"><span itemprop="name">web-security</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">文件上传</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>文件上传</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-upload-vulnerabilities">File upload vulnerabilities<a href="#file-upload-vulnerabilities" class="hash-link" aria-label="File upload vulnerabilities的直接链接" title="File upload vulnerabilities的直接链接">​</a></h2>
<p>文件上传漏洞是指Web服务器允许用户将文件上传到其文件系统，而没有充分验证其<strong>名称，类型，内容或大小</strong>等内容，造成远程代码执行</p>
<p><img decoding="async" loading="lazy" alt="file-upload-vulnerabilities" src="/assets/images/file-upload-vulnerabilities-00b9515c94d4d67015bf58f3e87e85a0.jpg" width="837" height="376" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="文件上传漏洞危害">文件上传漏洞危害<a href="#文件上传漏洞危害" class="hash-link" aria-label="文件上传漏洞危害的直接链接" title="文件上传漏洞危害的直接链接">​</a></h2>
<p><strong>文件类型未正确验证</strong>，并且服务器配置允许将某些类型的文件（例如 <code>.php</code> 和 <code>.jsp</code>）作为代码执行。</p>
<p><strong>文件名未正确验证</strong>，则可能允许攻击者仅通过上传同名文件来覆盖关键文件。如果服务器存在目录遍历漏洞，可能会上传到任意目录</p>
<p><strong>文件大小未正确验证</strong>，未能确保文件大小在预期阈值内还可能启用某种形式的拒绝服务 （DoS） 攻击，攻击者借此填充可用磁盘空间。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="文件上传的缺陷验证">文件上传的缺陷验证<a href="#文件上传的缺陷验证" class="hash-link" aria-label="文件上传的缺陷验证的直接链接" title="文件上传的缺陷验证的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="错误的文件类型验证"><strong>错误的文件类型验证</strong><a href="#错误的文件类型验证" class="hash-link" aria-label="错误的文件类型验证的直接链接" title="错误的文件类型验证的直接链接">​</a></h3>
<p>网站可能尝试验证文件上传的一种方法是检查此特定于输入的 <code>Content-Type</code> 标头是否与预期的 MIME 类型匹配。</p>
<p>例如，如果服务器仅需要图像文件，则它可能只允许 <code>image/jpeg</code> 和 <code>image/png</code> 等类型。</p>
<p>当服务器隐式信任此 Headers 的值时，可能会出现问题。</p>
<p>如果没有执行进一步的验证来检查文件的内容是否真的与假定的 MIME 类型匹配就会被绕过</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="阻止在用户可访问的目录中执行文件">阻止在用户可访问的目录中执行文件<a href="#阻止在用户可访问的目录中执行文件" class="hash-link" aria-label="阻止在用户可访问的目录中执行文件的直接链接" title="阻止在用户可访问的目录中执行文件的直接链接">​</a></h3>
<p>虽然首先防止上传危险的文件类型显然更好，但第二道防线是阻止服务器执行任何漏网的脚本。</p>
<p>作为预防措施，服务器通常只运行其 <strong>MIME 类型</strong>已明确配置为执行的脚本</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="黑名单的不足">黑名单的不足<a href="#黑名单的不足" class="hash-link" aria-label="黑名单的不足的直接链接" title="黑名单的不足的直接链接">​</a></h3>
<p>防止用户上传恶意脚本的一个更明显的方法是将潜在危险的文件扩展名（如. php）列入黑名单。</p>
<p>黑名单的做法本身就有缺陷，因为很难显式地阻止可能用于执行代码的每个可能的文件扩展名。</p>
<p>这样的黑名单有时可以通过使用不太知名的替代文件扩展名来绕过，这些文件扩展名可能仍然是可执行的，例如.php5，.shtml等。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="覆盖服务器配置">覆盖服务器配置<a href="#覆盖服务器配置" class="hash-link" aria-label="覆盖服务器配置的直接链接" title="覆盖服务器配置的直接链接">​</a></h4>
<p>服务器通常不会执行文件，除非它们被配置为这样做。</p>
<p>例如，在Apache服务器执行客户端请求的PHP文件之前，开发人员可能必须将以下指令添加到<code>/etc/apache 2/apache2.conf</code>文件中：</p>
<div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LoadModule php_module /usr/lib/apache2/modules/libphp.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AddType application/x-httpd-php .php</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>许多服务器还允许开发人员在各个目录中创建特殊的配置文件，以便覆盖或添加到一个或多个全局设置</p>
<p>例如：apache服务器，将从名为<code>.htaccess</code>的文件（如果存在）加载特定于目录的配置。</p>
<p>类似地，在<code>IIS</code>服务器，可以使用<code>web.config</code>文件进行特定于目录的配置</p>
<p>如果不能上传脚本文件，但可以上传配置文件，通过配置文件可以使在黑名单之外的后缀名映射到可执行的MIME类型（<code>application/x-httpd-php</code>）</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="混淆文件扩展名">混淆文件扩展名<a href="#混淆文件扩展名" class="hash-link" aria-label="混淆文件扩展名的直接链接" title="混淆文件扩展名的直接链接">​</a></h4>
<p>假设验证代码区分大小写，无法识别<code>exploit.pHp</code>实际上是一个<code>.php</code>文件，如果随后将<strong>文件扩展名映射到 MIME 类型</strong>的代码<strong>不</strong>区分大小写，则可以执行<code>PHP</code>文件</p>
<p><strong>一些可能绕过后端的方法：</strong></p>
<p>​	提供多个扩展：<code>exploit.php.jpg</code></p>
<p>​	拼接符号，一些组件会去除或忽略尾随的空格、点等：<code>exploit.php。</code></p>
<p>​	尝试对点、正斜杠和反斜杠使用 URL 编码（或双 URL 编码）。如果在验证文件扩展名时该值未解码，但稍后在服务器端解码，则还允许上传恶意文件，否则这些文件将被阻止：<code>exploit%2Ephp</code></p>
<p>​	在文件扩展名之前添加分号或 URL 编码的空字节字符。例如，如果验证是用<code>PHP</code>或<code>java</code>等高级语言编写的，但服务器使用<code> C/C++</code> 中的较低级别函数处理文件，这可能会导致文件名末尾的末尾出现差异：<code>exploit.asp;。JPG</code> 或 <code>exploit.asp%00.jpg</code>。</p>
<p>​	在许多编程语言和系统中，字符串是以空字符<code>\0</code>作为结束标志的。这意味着在处理字符串时，遇到空字符时将停止读取该字符串。</p>
<p>​	尝试使用多字节 Unicode 字符，这些字符在 Unicode 转换或规范化后可能会转换为 <strong>null 字节和点</strong>。如果文件名解析为 UTF-8 字符串，则 <code>xC0 x2E</code>、<code>xC4 xAE</code> 或 <code>xC0 xAE</code> 等序列可以转换为 <code>x2E</code>（点），但在路径中使用之前转换为 ASCII 字符。</p>
<p>其他防御措施包括去除或替换危险的扩展名以防止文件被执行。如果此转换不是以<strong>递归方式应用的</strong>，则仍会留下有效文件扩展名的方式定位禁止的字符串。例如，去除 <code>.php</code> 会发生什么情况：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">exploit.p.phphp --&gt; exploit.php</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="错误文件内容的验证">错误文件内容的验证<a href="#错误文件内容的验证" class="hash-link" aria-label="错误文件内容的验证的直接链接" title="错误文件内容的验证的直接链接">​</a></h3>
<p>与隐式信任请求中指定的<code>Content-Type</code>不同，更安全的服务器尝试<strong>验证文件的内容</strong>是否与预期的内容实际匹配。</p>
<p>在图像上传功能的情况下，服务器可能会尝试验证图像的某些固有属性，例如：尺寸。</p>
<p>同样，某些文件类型的魔术头是固定的，例如，<code>jpeg</code>文件的头部为：<code>FF D8 FF</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用文件上传竞争条件">利用文件上传竞争条件<a href="#利用文件上传竞争条件" class="hash-link" aria-label="利用文件上传竞争条件的直接链接" title="利用文件上传竞争条件的直接链接">​</a></h3>
<p>一些网站将文件直接上传到主文件系统，如果文件未通过验证，则再次将其删除。</p>
<p>这种行为在依赖防病毒软件等来检查恶意软件的网站中很常见。</p>
<p>这可能只需要几毫秒，但在文件存在于服务器上的短时间内，攻击者可能仍可以执行它。</p>
<p>例如：一个上传<code>config.php</code>，一个访问<code>config.php</code>，在存在的时间内执行命令</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /my-account/avatar HTTP/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET /files/avatars/config.php HTTP/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="上传无需远程执行的文件">上传无需远程执行的文件<a href="#上传无需远程执行的文件" class="hash-link" aria-label="上传无需远程执行的文件的直接链接" title="上传无需远程执行的文件的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="存储型xss">存储型XSS<a href="#存储型xss" class="hash-link" aria-label="存储型XSS的直接链接" title="存储型XSS的直接链接">​</a></h3>
<p>虽然可能无法在服务器上执行脚本，但仍然可以上传脚本进行客户端攻击。</p>
<p>例如，如果可以上传HTML文件或SVG图像，那么可以潜在地使用<code>&lt;script&gt;</code>标记来创建存储的XSS</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件解析漏洞">文件解析漏洞<a href="#文件解析漏洞" class="hash-link" aria-label="文件解析漏洞的直接链接" title="文件解析漏洞的直接链接">​</a></h3>
<p>如果上传的文件看起来存储和提供都很安全，最后的手段是尝试利用特定于解析或处理不同文件格式的漏洞。</p>
<p>例如，您知道服务器解析基于XML的文件，如<code>.doc</code>或<code>.xls</code>文件，这可能是<code>XXE</code>注入攻击的潜在载体</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="put-上传文件">PUT 上传文件<a href="#put-上传文件" class="hash-link" aria-label="PUT 上传文件的直接链接" title="PUT 上传文件的直接链接">​</a></h2>
<p>值得注意的是，一些Web服务器可能被配置为支持PUT请求。</p>
<p>如果没有适当的防御措施，这可能会提供一种上传恶意文件的替代方法，即使通过Web界面无法使用上传功能。</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT /images/exploit.php HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: vulnerable-website.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/x-httpd-php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length: 49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php echo file_get_contents(&#x27;/path/to/file&#x27;); ?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>tip：</p>
<p>可以尝试将<code>OPTIONS</code>请求发送到不同的路径，以测试是否支持<code>PUT</code>方法</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何防止文件上传漏洞">如何防止文件上传漏洞<a href="#如何防止文件上传漏洞" class="hash-link" aria-label="如何防止文件上传漏洞的直接链接" title="如何防止文件上传漏洞的直接链接">​</a></h2>
<p>设置白名单，只需要你想允许的扩展名</p>
<p>确保文件名不被目录遍历（<code>../</code>）</p>
<p>重命名上传的文件以避免可能导致现有文件被覆盖的冲突</p>
<p>在文件经过完全验证之前，不要将文件上传到服务器的永久文件系统</p>
<p>尽可能使用已建立的框架来预处理文件上传，而不是尝试编写自己的验证机制</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="labs">labs<a href="#labs" class="hash-link" aria-label="labs的直接链接" title="labs的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="不受限制的文件上传">不受限制的文件上传<a href="#不受限制的文件上传" class="hash-link" aria-label="不受限制的文件上传的直接链接" title="不受限制的文件上传的直接链接">​</a></h3>
<p>上传一句话木马</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token delimiter important">&lt;?php</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">echo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">system</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string single-quoted-string" style="color:#e3116c">&#x27;command&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token delimiter important">?&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20250508135353494" src="/assets/images/image-20250508135353494-39029be5ba3c941d9fd4edf11f6f0c72.png" width="1499" height="137" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="content-type-bypass">Content-Type bypass<a href="#content-type-bypass" class="hash-link" aria-label="Content-Type bypass的直接链接" title="Content-Type bypass的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20250508135707080" src="/assets/images/image-20250508135707080-61b9991edcb5f00a0f0a9a49e03055fc.png" width="1472" height="269" class="img_ev3q"></p>
<p>仅允许<code>image/jpeg</code>和<code>image/png</code>文件上传</p>
<p>修改<code>Content-Type</code></p>
<p><img decoding="async" loading="lazy" alt="image-20250508135903885" src="/assets/images/image-20250508135903885-75929801fb98189b04980d43527e9acb.png" width="1348" height="667" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用路径遍历上传-webshell">利用路径遍历上传 webshell<a href="#利用路径遍历上传-webshell" class="hash-link" aria-label="利用路径遍历上传 webshell的直接链接" title="利用路径遍历上传 webshell的直接链接">​</a></h3>
<p>上传之后，文件内容以文本形式被打印出来，说明php代码没有被执行</p>
<p><img decoding="async" loading="lazy" alt="image-20250508141130347" src="/assets/images/image-20250508141130347-70efd58a92bb0687b3bd4beb38e24ed9.png" width="1129" height="182" class="img_ev3q"></p>
<p>在<code>filename</code>参数尝试<code>../</code>，将文件上传到别的目录</p>
<p>依旧是上传到了<code>avatars/config.php</code>，说明后端对filename过滤了<code>../</code></p>
<p><img decoding="async" loading="lazy" alt="image-20250508141743325" src="/assets/images/image-20250508141743325-cde61ad421101d1828218072c5be46c6.png" width="1470" height="695" class="img_ev3q"></p>
<p>URL编码绕过</p>
<p><img decoding="async" loading="lazy" alt="image-20250508141909637" src="/assets/images/image-20250508141909637-f5fa4bcba771b033668de1cffebc7371.png" width="1482" height="724" class="img_ev3q"></p>
<p>成功上传到上级目录</p>
<p><img decoding="async" loading="lazy" alt="image-20250508141929511" src="/assets/images/image-20250508141929511-40c800d6f5d05a8ee54eda92a1a3ed38.png" width="1383" height="213" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件-bypass-黑名单">配置文件 bypass 黑名单<a href="#配置文件-bypass-黑名单" class="hash-link" aria-label="配置文件 bypass 黑名单的直接链接" title="配置文件 bypass 黑名单的直接链接">​</a></h3>
<p>上传<code>.htaccess</code>文件，将png文件映射为可执行的MIME类型</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AddType application/x-httpd-php .png</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image-20250508143733207" src="/assets/images/image-20250508143733207-57dcc8f4f27a553511bdce05d26c8ea9.png" width="1469" height="744" class="img_ev3q"></p>
<p>上传<code>config.png</code></p>
<p><img decoding="async" loading="lazy" alt="image-20250508144034561" src="/assets/images/image-20250508144034561-e20cc42d8958b588cadb3ba26e31e494.png" width="1428" height="726" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20250508144050874" src="/assets/images/image-20250508144050874-98577e8983eab72106160b698f603dae.png" width="1494" height="288" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="混淆文件扩展名-1">混淆文件扩展名<a href="#混淆文件扩展名-1" class="hash-link" aria-label="混淆文件扩展名的直接链接" title="混淆文件扩展名的直接链接">​</a></h3>
<p>使用<code>%00</code>进行截断，在验证后缀名时，验证为<code>.jpg</code>，但是服务端读到<code>%00</code>，就忽略后面字符了</p>
<p><img decoding="async" loading="lazy" src="/assets/images/image-20250508150645677-d0181713589697e046265265e1a68229.png" width="1481" height="732" class="img_ev3q"></p>
<p>参考：</p>
<p><a href="https://lddp.github.io/2018/11/21/WEB-00%E6%88%AA%E6%96%AD%E4%B8%8E-00%E6%88%AA%E6%96%AD/#toc-heading-1" target="_blank" rel="noopener noreferrer">https://lddp.github.io/2018/11/21/WEB-00%E6%88%AA%E6%96%AD%E4%B8%8E-00%E6%88%AA%E6%96%AD/#toc-heading-1</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="魔术头部-bypass">魔术头部 bypass<a href="#魔术头部-bypass" class="hash-link" aria-label="魔术头部 bypass的直接链接" title="魔术头部 bypass的直接链接">​</a></h3>
<p>上传<code>php</code>文件，响应是：<code>file is not a valid image</code></p>
<p><img decoding="async" loading="lazy" alt="image-20250508152041175" src="/assets/images/image-20250508152041175-e3267cb97f73e0a9363f16021e6c1ee2.png" width="1442" height="742" class="img_ev3q"></p>
<p>可能有文件内容检测</p>
<p>通过添加<code>GIF89a</code>，就是<code>GIF</code>的魔术头部</p>
<p><img decoding="async" loading="lazy" alt="image-20250508152153978" src="/assets/images/image-20250508152153978-920aad4a24ff818d71e0285012066b71.png" width="1469" height="749" class="img_ev3q"></p>
<p>第二种方法：</p>
<p>创建一个多语言<code>PHP/JPG</code>文件，该文件基本上是普通图像，但在其元数据中包含<code> PHP payload</code></p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">exiftool -Comment=&#x27;&lt;?php echo system($_GET[&quot;command&quot;]);&#x27; 22.jpg -o polyglot.php</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="条件竞争">条件竞争<a href="#条件竞争" class="hash-link" aria-label="条件竞争的直接链接" title="条件竞争的直接链接">​</a></h3>
<p>上传数据包：</p>
<p><img decoding="async" loading="lazy" alt="image-20250508161822535" src="/assets/images/image-20250508161822535-d005e2bbdd42afab200e57924b438b50.png" width="1916" height="823" class="img_ev3q"></p>
<p>竞争数据包：</p>
<p><img decoding="async" loading="lazy" alt="image-20250508161851804" src="/assets/images/image-20250508161851804-7fb9add66ea699f719477424895005b0.png" width="1920" height="757" class="img_ev3q"></p>
<p>查看200的响应</p>
<p><img decoding="async" loading="lazy" alt="image-20250508161921896" src="/assets/images/image-20250508161921896-a27240945f7aaa98fe48301e48d36c9d.png" width="1895" height="771" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/C0rr3c7/C0rr3c7.github.io/tree/master/docs/PortSwigger/web-security/文件上传.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/PortSwigger/web-security/命令执行"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">命令执行</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/PortSwigger/web-security/路径遍历"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">路径遍历</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#file-upload-vulnerabilities" class="table-of-contents__link toc-highlight">File upload vulnerabilities</a></li><li><a href="#文件上传漏洞危害" class="table-of-contents__link toc-highlight">文件上传漏洞危害</a></li><li><a href="#文件上传的缺陷验证" class="table-of-contents__link toc-highlight">文件上传的缺陷验证</a><ul><li><a href="#错误的文件类型验证" class="table-of-contents__link toc-highlight"><strong>错误的文件类型验证</strong></a></li><li><a href="#阻止在用户可访问的目录中执行文件" class="table-of-contents__link toc-highlight">阻止在用户可访问的目录中执行文件</a></li><li><a href="#黑名单的不足" class="table-of-contents__link toc-highlight">黑名单的不足</a></li><li><a href="#错误文件内容的验证" class="table-of-contents__link toc-highlight">错误文件内容的验证</a></li><li><a href="#利用文件上传竞争条件" class="table-of-contents__link toc-highlight">利用文件上传竞争条件</a></li></ul></li><li><a href="#上传无需远程执行的文件" class="table-of-contents__link toc-highlight">上传无需远程执行的文件</a><ul><li><a href="#存储型xss" class="table-of-contents__link toc-highlight">存储型XSS</a></li><li><a href="#文件解析漏洞" class="table-of-contents__link toc-highlight">文件解析漏洞</a></li></ul></li><li><a href="#put-上传文件" class="table-of-contents__link toc-highlight">PUT 上传文件</a></li><li><a href="#如何防止文件上传漏洞" class="table-of-contents__link toc-highlight">如何防止文件上传漏洞</a></li><li><a href="#labs" class="table-of-contents__link toc-highlight">labs</a><ul><li><a href="#不受限制的文件上传" class="table-of-contents__link toc-highlight">不受限制的文件上传</a></li><li><a href="#content-type-bypass" class="table-of-contents__link toc-highlight">Content-Type bypass</a></li><li><a href="#利用路径遍历上传-webshell" class="table-of-contents__link toc-highlight">利用路径遍历上传 webshell</a></li><li><a href="#配置文件-bypass-黑名单" class="table-of-contents__link toc-highlight">配置文件 bypass 黑名单</a></li><li><a href="#混淆文件扩展名-1" class="table-of-contents__link toc-highlight">混淆文件扩展名</a></li><li><a href="#魔术头部-bypass" class="table-of-contents__link toc-highlight">魔术头部 bypass</a></li><li><a href="#条件竞争" class="table-of-contents__link toc-highlight">条件竞争</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Blog, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>